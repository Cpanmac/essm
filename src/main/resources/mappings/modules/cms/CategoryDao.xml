<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.eryansky.modules.cms.dao.CategoryDao">
    
	<sql id="cmsCategoryDaoColumns">
		a.id AS "id",
		a.status AS "status",
		a.version AS "version",
		a.create_user AS "createUser",
		a.create_time AS "createTime",
		a.update_user AS "updateUser",
		a.update_time AS "updateTime",
		a.parent_id AS "parent.id",
		a.parent_ids AS "parentIds",
		a.site_id AS "site.id",
		a.organ_id AS "organId",
		a.module AS "module",
		a.name AS "name",
		a.code AS "code",
		a.image AS "image",
		a.href AS "href",
		a.target AS "target",
		a.description AS "description",
		a.keywords AS "keywords",
		a.sort AS "sort",
		a.in_menu AS "inMenu",
		a.in_list AS "inList",
		a.show_modes AS "showModes",
		a.allow_comment AS "allowComment",
		a.is_audit AS "isAudit",
		a.custom_list_view AS "customListView",
		a.custom_content_view AS "customContentView",
		a.view_config AS "viewConfig",
		a.device_config AS "deviceConfig",
		a.parent_id AS "parent.id",
		c.name AS "parent.name",
		c.view_config AS "parent.viewConfig",
		o.name AS "organName",
		s.id AS "site.id",
		s.code AS "site.code",
		s.theme AS "site.theme"
	</sql>
	
	<sql id="cmsCategoryDaoJoins">
	    LEFT JOIN t_cms_category c ON c.id = a.parent_id
		JOIN t_sys_organ o ON o.id = a.organ_id
		JOIN t_sys_user u ON u.id = a.create_user
		JOIN t_cms_site s ON a.site_id = s.id
	</sql>
    
	<select id="get" resultType="Category">
		SELECT 
			a.id AS "id",
			a.status AS "status",
			a.version AS "version",
			a.create_user AS "createUser",
			a.create_time AS "createTime",
			a.update_user AS "updateUser",
			a.update_time AS "updateTime",
			a.parent_id AS "parent.id",
			a.parent_ids AS "parentIds",
			a.site_id AS "site.id",
			a.organ_id AS "organId",
			a.module AS "module",
			a.name AS "name",
			a.code AS "code",
			a.image AS "image",
			a.icon AS "icon",
			a.href AS "href",
			a.target AS "target",
			a.description AS "description",
			a.keywords AS "keywords",
			a.sort AS "sort",
			a.in_menu AS "inMenu",
			a.in_menu AS "inList",
			a.show_modes AS "showModes",
			a.allow_comment AS "allowComment",
			a.is_audit AS "isAudit",
			a.custom_list_view AS "customListView",
			a.custom_content_view AS "customContentView",
			a.device_config AS "deviceConfig",
			a.parent_id AS "parent.id",
			c.name AS "parent.name",
			a.view_config AS "viewConfig",
			o.id AS "organId",
			o.name AS "organName",
			s.id AS "site.id"
		FROM t_cms_category a
		LEFT JOIN t_cms_category c ON c.id = a.parent_id
		JOIN t_sys_organ o ON o.id = a.organ_id
		JOIN t_cms_site s ON a.site_id = s.id
-- 		JOIN t_sys_user u ON u.id = a.create_user
		WHERE a.id = #{id}
	</select>

	<select id="getByCode" resultType="Category">
		SELECT
		<include refid="cmsCategoryDaoColumns"/>
		FROM t_cms_category a
		<include refid="cmsCategoryDaoJoins"/>
		WHERE a.code = #{code}
		AND a.status = #{STATUS_NORMAL}
	</select>

	<select id="find" resultType="Category">
		SELECT 
			<include refid="cmsCategoryDaoColumns"/>
		FROM t_cms_category a
		<include refid="cmsCategoryDaoJoins"/>
		<where>
			a.status = #{STATUS_NORMAL}
		</where>
		<choose>
			<when test="entityPage !=null and entityPage.orderBy != null and entityPage.orderBy != ''">
				ORDER BY ${entityPage.orderBy}
			</when>
			<otherwise>
				ORDER BY a.update_time DESC
			</otherwise>
		</choose>
	</select>
	
	<select id="findList" resultType="Category">
		SELECT 
			<include refid="cmsCategoryDaoColumns"/>
		FROM t_cms_category a
		<include refid="cmsCategoryDaoJoins"/>
		<where>
			a.status = #{STATUS_NORMAL}
			<if test=" site.id != null and site.id != ''">
				AND a.site_id  = #{site.id}
			</if>
			<if test="parent.id != null and parent.id != ''">
				AND a.parent_id  = #{parent.id}
			</if>
			${sqlMap.dsf}
		</where>		
			ORDER BY a.site_id,a.sort ASC
	</select>
	
	<select id="findModule" resultType="Category">
		SELECT 
			<include refid="cmsCategoryDaoColumns"/>
		FROM t_cms_category a
		<include refid="cmsCategoryDaoJoins"/>
		<where>
			a.status = #{STATUS_NORMAL}
			<if test=" site.id != null and site.id != ''">
				AND a.site_id  = #{site.id}
			</if>
			<if test="parent.id != null and parent.id != ''">
				AND a.parent_id  = #{parent.id}
			</if>
			<if test="module != null and module != ''">
				AND a.module = #{module}
			</if>
			<if test="deviceConfig != null and deviceConfig != ''">
				AND a.device_config LIKE
				<if test="dbName == 'db2'">'%'||#{deviceConfig}||'%'</if>
				<if test="dbName == 'mysql'">CONCAT('%', #{deviceConfig}, '%')</if>
			</if>
			<if test="inMenu != null and inMenu != '' ">
				AND a.in_menu  = #{inMenu}
			</if>
			${sqlMap.dsf}
		</where>		
			ORDER BY a.site_id,a.sort ASC
	</select>
	
	<insert id="insert">
		INSERT INTO t_cms_category(
			id,
			status,
			version,
			create_user,
			create_time,
			update_user,
			update_time,
			parent_id,
			parent_ids,
			site_id,
			organ_id,
			module,
			name,
			code,
			image,
			icon,
			href,
			target,
			description,
			keywords,
			sort,
			in_menu,
			in_list,
			show_modes,
			allow_comment,
			is_audit,
			custom_list_view,
			custom_content_view,
			view_config,
			device_config
		) VALUES (
			#{id},
			#{status},
			0,
			#{createUser},
			#{createTime},
			#{updateUser},
			#{updateTime},
			#{parent.id},
			#{parentIds},
			#{site.id},
			#{organId},
			#{module},
			#{name},
			#{code},
			#{image},
			#{icon},
			#{href},
			#{target},
			#{description},
			#{keywords},
			#{sort},
			#{inMenu},
			#{inList},
			#{showModes},
			#{allowComment},
			#{isAudit},
			#{customListView},
			#{customContentView},
			#{viewConfig},
			#{deviceConfig}
		)
	</insert>
	
	<update id="update">
		UPDATE t_cms_category SET
			status = #{status},
			version = version +1,
			update_user = #{updateUser},
			update_time = #{updateTime},
			parent_id = #{parent.id},
			parent_ids = #{parentIds},
			site_id = #{site.id},
			organ_id = #{organId},
			module = #{module},
			name = #{name},
			code = #{code},
			image = #{image},
			icon = #{icon},
			href = #{href},
			target = #{target},
			description = #{description},
			keywords = #{keywords},
			sort = #{sort},
			in_menu = #{inMenu},
			in_list = #{inList},
			show_modes = #{showModes},
			allow_comment = #{allowComment},
			is_audit = #{isAudit},
			custom_list_view = #{customListView},
			custom_content_view = #{customContentView},
			view_config = #{viewConfig},
			device_config = #{deviceConfig}
		WHERE id = #{id}
	</update>
	
	<update id="updateParentIds">
		UPDATE t_cms_category SET
			parent_id = #{parent.id}, 
			parent_ids = #{parentIds}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		UPDATE t_cms_category SET
			status = #{STATUS_DELETE}
		WHERE id = #{id}
	</update>
	
	<select id="findByParentIdAndSiteId" resultType="Category">
		SELECT 
			<include refid="cmsCategoryDaoColumns"/>
		FROM t_cms_category a
		<include refid="cmsCategoryDaoJoins"/>
		<where>
			a.status = #{STATUS_NORMAL}
			<if test=" site.id != null and site.id != ''">
				AND a.site_id  = #{site.id}
			</if>
			<if test="parent.id != null and parent.id != ''">
				AND a.parent_id  = #{parent.id}
			</if>
		</where>		
		order by a.site_id, a.sort
	</select>
	<select id="findByParentIdsLike" resultType="Category">
		SELECT 
			<include refid="cmsCategoryDaoColumns"/>
		FROM t_cms_category a
		<include refid="cmsCategoryDaoJoins"/>
		<where>
			a.status = #{STATUS_NORMAL}
			AND a.parent_id LIKE 
					<if test="dbName == 'db2'">'%'||#{id}||'%'</if>
					<if test="dbName == 'mysql'">CONCAT('%', #{id}, '%')</if>
		</where>		
		order by a.site_id, a.sort
	</select>
	
	<select id="findStats" resultType="java.util.Map" parameterType="java.util.Map">
		select max(c.id) as categoryId,
		       max(c.name) as categoryName,
		       max(cp.id) as categoryParentId,
		       max(cp.name) as categoryParentName,
		       count(*) as cnt,
		       sum(a.hits) as hits,
		       max(a.updateTime) as updateTime,
		       max(o.id) as organId,
		       max(o.name) as organName,
		  from t_cms_article a
		  JOIN t_cms_category c ON c.id = a.category_id
		  JOIN t_cms_category cp ON c.parent_id = cp.id
		  JOIN t_sys_organ o ON o.id = c.organ_id
		<where>
			a.status = #{STATUS_NORMAL}
			AND a.category_id
			AND c.site_id =
			AND c.id = :id or c.parent_ids LIKE 
					<if test="dbName == 'db2'">'%'||#{parentIds}||'%'</if>
					<if test="dbName == 'mysql'">CONCAT('%', #{parentIds}, '%')</if>
			group by cp.sort, cp.id, c.sort, c.id
			order by cp.sort, cp.id, c.sort, c.id
		</where>		
	</select>
</mapper>