var $folder_tree;var contextMenuNode;var $folder_form;var $folder_dialog;var file_share_chooseUser_dialog;var $folder_file_search_form;var $folder_file_datagrid;var $share_file_form;var defaultSelectedNode=null;var folder_file_toolbar={text:"上传文件",iconCls:"eu-icon-upload",handler:function(){addFolderFile()}};$(function(){$folder_file_search_form=$("#folder_file_search_form").form();loadDiskTree();loadFileDatagrid()});function loadFileDatagrid(){$folder_file_datagrid=$("#folder_file_datagrid").datagrid({url:"",checkOnSelect:false,selectOnCheck:false,fit:true,fitColumns:false,striped:true,remoteSort:false,idField:"id",frozen:true,collapsible:true,showFooter:true,pagination:true,rownumbers:true,pageSize:20,pageList:[10,20,50,500,9999],frozenColumns:[[{field:"ck",checkbox:true},{field:"name",title:"文件名",sortable:true,width:260,formatter:function(b,a,c){if(b!="总大小"){return"<a onclick='downloadFile(\""+a.fileId+"\")'>"+b+"</a>"}else{return b}},editor:{type:"validatebox",options:{required:true,missingMessage:"请输入名称！",validType:["minLength[1]","length[1,200]"]}}}]],columns:[[{field:"id",title:"主键",hidden:true,sortable:true,align:"right",width:80},{field:"prettyFileSize",title:"文件大小",sortable:true,align:"right",width:110},{field:"userName",title:"上传人",width:100},{field:"shareUserName",title:"分享人",width:100,hidden:true},{field:"shareTime",title:"分享时间",width:150,sortable:true,hidden:true},{field:"receiveLocation",title:"分享位置",width:300,hidden:true},{field:"createTime",title:"上传时间",sortable:true,width:200},{field:"operate_all",title:"操作",formatter:function(h,b,f){var c="";if(b.id){if(b.editing){c="<a class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-save\"' onclick='saveFileName(this,"+f+',"'+b.id+"\")' >保存 </a>";c+="&nbsp;<a class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-cancel\"' onclick='rejectChanges("+f+");' >取消  </a>"}else{c="<a class='easyui-linkbutton' data-options='iconCls:\"eu-icon-disk_download\"' onclick='downloadFile(\""+b.fileId+"\")'>下载</a>";if(defaultSelectedNode!=null){var g="&nbsp;<a class='easyui-linkbutton' data-options='iconCls:\"eu-icon-disk_share\"' onclick='shareFolderFile(\""+b.id+"\")'>分享</a>&nbsp;";var j="&nbsp;<a class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-edit\"' onclick='beginEdit("+f+")'>更名</a>";var e="&nbsp;<a class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-remove\"' onclick='delFolderFile(\""+b.id+'","'+b.name+"\")'>删除</a>&nbsp";var i="&nbsp;<a class='easyui-linkbutton' data-options='iconCls:\"eu-icon-disk_collect\"' onclick='collectFolderFile(\""+b.id+"\")'>收藏</a>&nbsp;";var d="&nbsp;<a class='easyui-linkbutton' data-options='iconCls:\"icon-cancel\"' onclick='removeShareFile(\""+b.id+"\")'>取消</a>&nbsp";var a="&nbsp;<a class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-cancel\"' onclick='removeReceiveFile(\""+b.id+"\")'>取消</a>&nbsp";if(h!=undefined&&h!=null){if($.inArray("EDIT",h)>-1){c+=j}if($.inArray("DELETE",h)>-1){c+=e}if($.inArray("COLLECT",h)>-1){c+=i}if($.inArray("SHARE",h)>-1){c+=g}if($.inArray("REMOVE_SHARE",h)>-1){c+=d}if($.inArray("REMOVE_RECEIVE",h)>-1){c+=a}}}}}return c}}]],onBeforeEdit:function(a,b){b.editing=true;updateActions(a);$.parser.parse($(".easyui-linkbutton").parent())},onAfterEdit:function(a,b){b.editing=false;updateActions(a);$.parser.parse($(".easyui-linkbutton").parent())},onCancelEdit:function(a,b){b.editing=false;updateActions(a);$.parser.parse($(".easyui-linkbutton").parent())},onLoadSuccess:function(){$(this).datagrid("clearSelections");$(this).datagrid("clearChecked");$(this).datagrid("unselectAll")},onHeaderContextMenu:function(b,a){b.preventDefault()}}).datagrid("showTooltip")}function loadDiskTree(){$folder_tree=$("#folder_tree").tree({url:ctxAdmin+"/disk/diskTree",formatter:function(a){return a.text},onClick:function(a){},onBeforeSelect:function(a){defaultSelectedNode=a;return true},onBeforeLoad:function(a,b){$("#folder_tree").html("数据加载中...")},onSelect:function(c){if(true&&$folder_file_datagrid){var f=c.attributes.nType;var i=c.attributes.type;var g=[{text:"批量下载",iconCls:"eu-icon-disk_download",handler:function(){downloadFile()}}];var a={};var b=$folder_file_datagrid.datagrid("getColumnOption","createTime");if("FolderAuthorize"==f){var j="6"==c.id;var d="7"==c.id;if(j||d){$folder_file_datagrid.datagrid("showColumn","shareTime");$folder_file_datagrid.datagrid("hideColumn","createTime");if(j){$folder_file_datagrid.datagrid("showColumn","receiveLocation")}else{$folder_file_datagrid.datagrid("showColumn","shareUserName");$folder_file_datagrid.datagrid("hideColumn","receiveLocation")}}else{$folder_file_datagrid.datagrid("hideColumn","receiveLocation");$folder_file_datagrid.datagrid("hideColumn","shareTime");$folder_file_datagrid.datagrid("hideColumn","shareUserName");$folder_file_datagrid.datagrid("showColumn","createTime")}if("5"==c.id){b.title="收藏时间"}else{b.title="上传时间"}}else{$folder_file_datagrid.datagrid("hideColumn","receiveLocation");$folder_file_datagrid.datagrid("hideColumn","shareTime");$folder_file_datagrid.datagrid("hideColumn","shareUserName");$folder_file_datagrid.datagrid("showColumn","createTime");b.title="上传时间"}if("FolderAuthorize"==f&&("0"==c.id||"4"==c.id)){g.unshift(folder_file_toolbar)}else{if("Organ"==f||"1"==i){g.unshift(folder_file_toolbar)}else{var h=c.attributes.operate;var e=$folder_tree.tree("getParent",c.target);while((h==undefined||h==null)&&e!=null){h=e.attributes.operate;e=$folder_tree.tree("getParent",e.target)}if(true==h){g.unshift(folder_file_toolbar)}}}if("Folder"==f){a={folderId:c.id}}else{if("FolderAuthorize"==f){a={folderAuthorize:c.id}}else{if("Organ"==f||"1"==i){a={folderOrgan:c.id}}}}$folder_file_datagrid.datagrid({toolbar:g,queryParams:a,url:ctxAdmin+"/disk/folderFileDatagrid"}).datagrid("showTooltip")}},onContextMenu:function(f,d){f.preventDefault();contextMenuNode=d;var a=d.attributes.nType;var b=d.attributes.type;var c="folder_treeMenu_add";if("Folder"==a){if(true==d.attributes.operate){c="folder_treeMenu_all"}else{c=""}}else{if("FolderAuthorize"==a&&("2"==d.id||"5"==d.id||"6"==d.id||"7"==d.id)){c=""}}if(""!=c){$("#"+c).menu({onClick:function(e){if("addFolder"==e.name){showFolderDialog()}else{if("editFolder"==e.name){showFolderDialog(d.id)}else{if("deleteFolder"==e.name){delFolder(d.id,d.text)}}}}}).menu("show",{left:f.pageX,top:f.pageY})}},onLoadSuccess:function(b,c){contextMenuNode=undefined;if(defaultSelectedNode!=null){defaultSelectedNode=$(this).tree("find",defaultSelectedNode.id);if(defaultSelectedNode!=null){$(this).tree("select",defaultSelectedNode.target)}}var a=$(this).tree("getRoots");if(defaultSelectedNode==null){$folder_tree.tree("select",a[0].target)}}})}function shareFolderFile(a){if(!a){eu.showMsg("请选择需要操作对象!")}else{file_share_chooseUser_dialog=$("<div/>").dialog({title:"分享方式选择",top:20,width:700,height:200,modal:true,maximizable:true,href:ctxAdmin+"/disk/share-file/"+a,buttons:[{text:"保存",iconCls:"easyui-icon-save",handler:function(){$share_file_form.submit()}},{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){file_share_chooseUser_dialog.dialog("destroy")}}],onClose:function(){$(this).dialog("destroy")},onLoad:function(){shareFileFormInit()}})}}function shareFileFormInit(){$share_file_form=$("#share_file_form").form({url:ctxAdmin+"/disk/shareFile",onSubmit:function(c){$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});var b=$(this).form("validate");if(b){var a=$("input[name='shareType']:radio:checked").val();if("PERSON"==a){if(multiSelectUser==undefined||multiSelectUser==null||multiSelectUser.value().length==0){eu.showAlertMsg("分享用户不能为空!","warning");b=false}}else{if("ORGAN"==a){if(multiSelectOrgan==undefined||multiSelectOrgan.combotree("getValue")==null||multiSelectOrgan.combotree("getValue").length==0){eu.showAlertMsg("分享部门不能为空!","warning");b=false}}}}if(!b){$.messager.progress("close")}return b},success:function(b){$.messager.progress("close");var a=$.parseJSON(b);if(a.code==1){file_share_chooseUser_dialog.dialog("destroy");$folder_file_datagrid.datagrid("reload");eu.showMsg(a.msg)}else{eu.showAlertMsg(a.msg,"error")}}})}function removeShareFile(a){if(!a){eu.showMsg("请选择需要操作对象!")}else{$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});$.ajax({url:ctxAdmin+"/disk/removeShare/"+a,type:"post",dataType:"json",traditional:true,success:function(b){$.messager.progress("close");if(b.code==1){$folder_file_datagrid.datagrid("reload");eu.showMsg(b.msg)}else{eu.showAlertMsg(b.msg,"error")}}})}}function collectFolderFile(b){if(!b){eu.showMsg("请选择需要操作对象!")}else{var c="";var a=defaultSelectedNode.attributes.nType;var d=defaultSelectedNode.id;if("FolderAuthorize"==a&&"7"==d){c=ctxAdmin+"/disk/CollectFile?pageId="+b+"&folderAuthorize="+d}else{c=ctxAdmin+"/disk/CollectFile?pageId="+b}$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});$.ajax({url:c,type:"post",dataType:"json",traditional:true,success:function(e){$.messager.progress("close");if(e.code==1){$folder_file_datagrid.datagrid("reload");eu.showMsg(e.msg)}else{eu.showAlertMsg(e.msg,"error")}}})}}function saveFileName(e,b,f){$folder_file_datagrid.datagrid("unselectAll");$folder_file_datagrid.datagrid("selectRow",b);$folder_file_datagrid.datagrid("endEdit",b);var a=$folder_file_datagrid.datagrid("getSelected");var d=$folder_file_datagrid.datagrid("validateRow",b);if(!d){var c=$folder_file_datagrid.datagrid("getEditor",{index:b,field:"name"});$(c.target).focus();return false}$.ajax({type:"POST",url:ctxAdmin+"/disk/fileSave",data:$.extend({id:a.id,modelType:"File"},a),traditional:true,dataType:"json",success:function(g){if(g.code==1){$folder_file_datagrid.datagrid("reload");eu.showMsg(g.msg)}}})}function updateActions(a){$folder_file_datagrid.datagrid("updateRow",{index:a,row:{}})}function beginEdit(a){$folder_file_datagrid.datagrid("beginEdit",a)}function rejectChanges(a){$folder_file_datagrid.datagrid("endEdit",a);$folder_file_datagrid.datagrid("rejectChanges",a)}function downloadFile(a){var c=new Array();if(a){c.push(a)}else{var d=$folder_file_datagrid.datagrid("getChecked");if(d&&true){$.each(d,function(e,f){c.push(f.fileId)})}}if(c.length>0){var b=ctxAdmin+"/disk/downloadDiskFile?fileIds="+c.join(",");$("#annexFrame").attr("src",b)}else{eu.showMsg("请选择要操作的对象！");return}}function showFolderDialog(b){var k=ctxAdmin+"/disk/folderInput";if(b!=undefined){k+="?folderId="+b}else{var g=$folder_tree.tree("getSelected");g=(contextMenuNode!=undefined)?contextMenuNode:g;if(g!=undefined&&g!=null){var i="";var f=g.attributes.nType;var h=g.attributes.type;var c=g.id;var a="";var d="";if("FolderAuthorize"==f&&("0"==c||"4"==c||"2"==c)){i=c}else{if("Organ"==f||"1"==h){i="2";a=c}else{if("Folder"==f){d=c;var e=$folder_tree.tree("getParent",g.target);if(e!=undefined&&"Organ"==e.attributes.nType){a=e.id}var j=$folder_tree.tree("getLevel",g.target);while(e!=undefined&&j!=2){j=$folder_tree.tree("getLevel",e.target);e=$folder_tree.tree("getParent",e.target);if(""==a&&"Organ"==e.attributes.nType){a=e.id}}if(e!=undefined){i=e.id}}}}k+="?folderAuthorize="+i+"&parentFolderId="+d+"&organId="+a}}$folder_dialog=$("<div/>").dialog({title:"文件夹信息",top:20,width:500,height:360,modal:true,maximizable:true,href:k,buttons:[{text:"保存",iconCls:"easyui-icon-save",handler:function(){$folder_form.submit()}},{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){$folder_dialog.dialog("destroy")}}],onClose:function(){$(this).dialog("destroy")},onLoad:function(){folderFormInit()}})}function folderFormInit(){$folder_form=$("#folder_form").form({url:ctxAdmin+"/disk/saveFolder",onSubmit:function(b){$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});var a=$(this).form("validate");if(!a){$.messager.progress("close")}else{b.modelType="Folder"}return a},success:function(b){$.messager.progress("close");var a=$.parseJSON(b);if(a.code==1){$folder_dialog.dialog("destroy");$folder_tree.tree("reload");eu.showMsg(a.msg)}else{if(a.code==2){$.messager.alert("提示信息！",a.msg,"warning",function(){if(a.obj){$('#$folder_form input[name="'+a.obj+'"]').focus()}})}else{eu.showAlertMsg(a.msg,"error")}}}})}function delFolder(a,b){$.messager.confirm("确认提示！","您确定要删除["+b+"],包含下级文件夹以及文件?",function(c){if(c){$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});$.ajax({url:ctxAdmin+"/disk/folderRemove/"+a,type:"post",dataType:"json",traditional:true,success:function(d){$.messager.progress("close");if(d.code==1){$folder_tree.tree("reload");$folder_file_datagrid.datagrid("reload");eu.showMsg(d.msg)}else{eu.showAlertMsg(d.msg,"error")}}})}})}function addFolderFile(){var e=$folder_tree.tree("getSelected");if(e!=undefined&&e.id!=undefined){var i=e.text;var g="上传文件";if(i!=undefined&&i!=null&&i!=""){g+=":"+i}var a=ctxAdmin+"/disk/fileInput";var h=null;var b=null;var c=null;var d=e.attributes.nType;var f=e.attributes.type;if("FolderAuthorize"==d&&"2"!=e.id){h=e.id;a+="?folderAuthorize="+h}else{if("Organ"==d||"1"==f){b=e.id;a+="?organId="+b}else{c=e.id;a+="?folderId="+c}}_dialog=$("<div/>").dialog({title:g,top:10,href:a,width:500,height:360,maximizable:true,iconCls:"eu-icon-file",modal:true,buttons:[{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){_dialog.dialog("destroy");$folder_file_datagrid.datagrid("reload")}}],onClose:function(){_dialog.dialog("destroy")}})}}function delFolderFile(a,d){var b=$folder_file_datagrid.datagrid("getChecked");if(a!=undefined||b.length>0){var c="您确定要删除";if(d!=undefined){if(defaultSelectedNode!=null&&"FolderAuthorize"==defaultSelectedNode.attributes.nType&&"5"==defaultSelectedNode.id){c+="收藏"}else{c+="文件"}c+="["+d+"]?"}else{c+="选中的所有文件?"}$.messager.confirm("确认提示！",c,function(e){if(e){var f=new Array();$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});if(a!=undefined){f.push(a)}else{$.each(b,function(g,h){f.push(h.id)})}$.ajax({url:ctxAdmin+"/disk/delFolderFile",type:"post",data:{fileIds:f},dataType:"json",traditional:true,success:function(g){$.messager.progress("close");if(g.code==1){$folder_file_datagrid.datagrid("reload");eu.showMsg(g.msg)}else{eu.showAlertMsg(g.msg,"error")}}})}})}else{eu.showMsg("请选择要操作的对象！")}}function search(){var c=$folder_tree.tree("getSelected");var a="";if(c){a=c.id}var b=$.extend($.serializeObject($folder_file_search_form),{folderId:a});$folder_file_datagrid.datagrid("load",b)}function removeReceiveFile(c){if(!c){eu.showMsg("请选择需要操作对象!")}else{if(defaultSelectedNode){var a=defaultSelectedNode.attributes.nType;var b=defaultSelectedNode.id;$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});$.ajax({url:ctxAdmin+"/disk/removeReceive?pageId="+c+"&nodeType="+a+"&nodeId="+b,type:"post",dataType:"json",traditional:true,success:function(d){$.messager.progress("close");if(d.code==1){$folder_file_datagrid.datagrid("reload");eu.showMsg(d.msg)}else{eu.showAlertMsg(d.msg,"error")}}})}}};