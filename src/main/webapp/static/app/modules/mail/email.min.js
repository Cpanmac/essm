var emailId=emailId;var $email_datagrid;var $email_search_form;var $email_input_dialog;var $email_view_dialog;var $selectrecvs_dialog;var $form_to_MultiSelect,$form_cc_MultiSelect;var $datagrid_query_sender_MultiSelect;var $datagrid_query_receiver_MultiSelect;var $datagrid_query_MultiSelect;var $email_form;var inbox_linkbutton_text="收件箱";var _operateType;var currentMailAccountId="";$(function(){receiveObjectIdsDisable();$email_search_form=$("#email_search_form").form();$("#sta").hide();$("#sta1").hide();initInboxDatagrid(true);initSelectUser();if(emailId!=""){view("Inbox",emailId)}mymessage()});function refreshMessage(){mymessage();parent.refreshPortal()}function mymessage(){$.ajax({url:ctxAdmin+"/mail/email/myMessage?mailAccountId="+currentMailAccountId,type:"get",dataType:"json",success:function(a){if(a.code==1){var b=a.obj;if(b.inboxs>0){var c=inbox_linkbutton_text+"&nbsp;<span style='color: red;'>（"+b.inboxs+"）</span>";$("#inbox_linkbutton").linkbutton({text:c})}else{$("#inbox_linkbutton").linkbutton({text:inbox_linkbutton_text})}}}})}function initEmailDatagrid(a){resetSearchForm();if(a=="Outbox"){$("#recv").show();$("#sta").hide();$("#sta1").hide();sendObjectIdsDisable();receiveObjectIdsEnable();initOutboxDatagrid()}else{if(a=="Draftbox"){$("#recv").hide();$("#sta").hide();$("#sta1").hide();sendObjectIdsEnable();receiveObjectIdsDisable();initOutboxDatagrid(true)}else{if(a=="Inbox"||a=="UnreadInbox"){$("#recv").show();if(a=="UnreadInbox"){$("#sta").hide();$("#sta1").hide()}else{$("#sta").show();$("#sta1").show()}sendObjectIdsEnable();receiveObjectIdsDisable();initInboxDatagrid(a=="UnreadInbox")}else{if(a=="RecycleBin"){$("#recv").show();$("#sta").hide();$("#sta1").hide();sendObjectIdsEnable();receiveObjectIdsDisable();initRecycleBinDatagrid()}}}}}function initInboxDatagrid(b){var a="Inbox";if(b!=undefined&&b==true){a="UnreadInbox"}$email_datagrid=$("#email_datagrid").datagrid({url:ctxAdmin+"/mail/email/"+a+"Datagrid",fit:true,pagination:true,fitColumns:false,striped:true,pageSize:20,singleSelect:false,rownumbers:true,checkbox:true,nowrap:true,border:false,checkOnSelect:false,selectOnCheck:false,remoteSort:false,sortName:"receiveTime",sortOrder:"desc",idField:"id",frozenColumns:[[{field:"ck",checkbox:true},{field:"senderName",title:"发件人",width:120},{field:"title",title:"邮件主题",width:360,formatter:function(e,d,c){if(d.senderName==undefined){e=e+"[<font color=#D94600>匿名</font>]"}var g="<a href='#' onclick='view(\""+a+'","'+d.emailId+"\")' >"+e+"</a>";var f="";if(d.isRead==0){f+='<img alt="未读" title="未读邮件" src="'+ctxStatic+'/app/modules/mail/img/new.gif">&nbsp;'+g}else{f+=g}if(d.priority==1){f+=' [<span style="color:#ff6600;">'+d.priorityView+"</span>]"}if(d.priority==2){f+=' [<span style="color:#ff0000;">'+d.priorityView+"</span>]"}return f}}]],columns:[[{field:"id",title:"主键",hidden:true,sortable:true,align:"right",width:80},{field:"receiveTime",title:"接收时间",hidden:true,sortable:true,align:"right",width:80},{field:"sendTime",title:"发送时间",width:150,sortable:true},{field:"isReadView",title:"邮件状态",width:80},{field:"priorityView",title:"优先级",width:80},{field:"operate",title:"操作",formatter:function(f,e,c){var d="<a href='#' class='easyui-linkbutton' data-options='iconCls:\"eu-icon-mail_reply_sender\"' onclick='edit(\"Reply\",\""+e.emailId+"\")' >回复</a>&nbsp;<a href='#' class='easyui-linkbutton' data-options='iconCls:\"eu-icon-mail_forward\"' onclick='edit(\"Repeat\",\""+e.emailId+"\")' >转发</a>";return d}}]],queryParams:{mailAccountId:currentMailAccountId},toolbar:[{text:"标记为已读",iconCls:"eu-icon-mail_mark_read",handler:function(){markReaded()}},{text:"删除",iconCls:"easyui-icon-remove",handler:function(){del(a)}}],onLoadSuccess:function(){$(this).datagrid("clearSelections");$(this).datagrid("clearChecked");$(this).datagrid("unselectAll");$(this).datagrid("uncheckAll")}}).datagrid("showTooltip")}function initOutboxDatagrid(b){var a="Outbox";var c=[{text:"删除",iconCls:"easyui-icon-remove",handler:function(){del(a)}}];if(b!=undefined&&b==true){a="Draftbox"}$email_datagrid=$("#email_datagrid").datagrid({url:ctxAdmin+"/mail/email/"+a+"Datagrid",fit:true,pagination:true,pagePosition:"bottom",fitColumns:false,striped:true,pageSize:20,singleSelect:false,rownumbers:true,checkbox:true,nowrap:true,border:false,remoteSort:false,sortName:"updateTime",sortOrder:"desc",idField:"id",frozenColumns:[[{field:"ck",checkbox:true}]],columns:[[{field:"id",title:"主键",hidden:true,sortable:true,align:"right",width:80},{field:"title",title:"邮件主题",width:360,formatter:function(f,e,d){if(e.outboxMode==3){f+='<span style="color: red;">'+e.outboxModeView+"</span>"}var g="<a href='#' onclick='view(\""+a+'","'+e.emailId+"\")' >"+f+"</a>";return g}},{field:"sendTime",title:"时间",width:150,sortable:true,formatter:function(f,e,d){if(e.sendTime==undefined){return e.createTime}return f}},{field:"priorityView",title:"优先级",width:80},{field:"updateTime",title:"更新时间",hidden:true,sortable:true,align:"right",width:80},{field:"operate",title:"操作",hidden:false,formatter:function(g,f,d){var e="";if(b!=undefined&&b==true){e+="&nbsp;<a href='#' class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-edit\"' onclick='edit(null,\""+f.emailId+"\");' >编辑</a>&nbsp;<a href='#' class='easyui-linkbutton' data-options='iconCls:\"eu-icon-mail_forward\"' onclick='sendEmail(\""+f.emailId+"\");' >发送</a>"}else{e+="&nbsp;<a href='#' class='easyui-linkbutton' data-options='iconCls:\"eu-icon-mail_forward\"' onclick='edit(\"Repeat\",\""+f.emailId+"\");' >转发</a>"}e+="&nbsp;<a href='#' class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-remove\"' onclick='del(\"Outbox\","+d+");' >删除</a>";if(f.isReceivesRead==false&&f.mailType==0&&f.mailAccountId==""&&f.outboxMode==0){e+="&nbsp;<a href='#' class='easyui-linkbutton' onclick='revoke("+d+");' >撤销</a>"}if(b==undefined||b==false){e+="&nbsp;<a href='#' class='easyui-linkbutton' data-options='iconCls:\"eu-icon-mail_find\"' onclick='emailReadInfo(\""+f.emailId+"\");' >阅读情况</a>"}return e}}]],queryParams:{mailAccountId:currentMailAccountId},toolbar:c,onLoadSuccess:function(){$(this).datagrid("clearSelections");$(this).datagrid("clearChecked");$(this).datagrid("unselectAll");$(this).datagrid("uncheckAll")}}).datagrid("showTooltip")}function initRecycleBinDatagrid(){var a="RecycleBin";$email_datagrid=$("#email_datagrid").datagrid({url:ctxAdmin+"/mail/email/"+a+"Datagrid",fit:true,pagination:true,pagePosition:"bottom",fitColumns:false,striped:true,pageSize:20,singleSelect:false,rownumbers:true,checkbox:true,nowrap:true,border:false,remoteSort:false,sortName:"delTime",sortOrder:"desc",idField:"id",frozenColumns:[[{field:"ck",checkbox:true}]],columns:[[{field:"id",title:"主键",hidden:true,sortable:true,align:"right",width:80},{field:"senderName",title:"发件人",width:80},{field:"title",title:"邮件主题",width:360,formatter:function(d,c,b){var e="<a href='#' onclick='view(\""+a+'","'+c.emailId+"\")' >"+d+"</a>";return e}},{field:"delTime",title:"删除时间",width:146,sortable:true},{field:"updateTime",title:"更新时间",hidden:true,sortable:true,align:"right",width:80},{field:"priorityView",title:"优先级",width:100},{field:"fromBoxView",title:"来源",width:100}]],queryParams:{mailAccountId:currentMailAccountId},toolbar:[{text:"恢复",iconCls:"eu-icon-mail_restore",handler:function(){reduce()}},"-",{text:"永久删除",iconCls:"eu-icon-mail_delete_complete",handler:function(){clearEmail()}}],onLoadSuccess:function(){$(this).datagrid("clearSelections");$(this).datagrid("clearChecked");$(this).datagrid("unselectAll");$(this).datagrid("uncheckAll")}}).datagrid("showTooltip")}function convertValues(a){var c="";if(a!=undefined){c=a.input.val()}var b={};b.query=c;return b}function initSelectUser(){var a=currentMailAccountId;if("1"==currentMailAccountId){a=""}$datagrid_query_sender_MultiSelect=$("#sendObjectIds").kendoMultiSelect({dataTextField:"name",dataValueField:"id",groupTemplate:"#: data #",dataSource:{transport:{read:{url:ctxAdmin+"/sys/user/customUserList",dataType:"json"},parameterMap:function(c,b){if(b=="read"){return convertValues($datagrid_query_sender_MultiSelect)}}},serverFiltering:true,group:{field:"defaultOrganName"}}}).data("kendoMultiSelect");$datagrid_query_receiver_MultiSelect=$("#receiveObjectIds").kendoMultiSelect({dataTextField:"name",dataValueField:"id",groupTemplate:"#: data #",dataSource:{transport:{read:{url:ctxAdmin+"/sys/user/customUserList",dataType:"json"},parameterMap:function(c,b){if(b=="read"){return convertValues($datagrid_query_receiver_MultiSelect)}}},serverFiltering:true,group:{field:"defaultOrganName"}}}).data("kendoMultiSelect")}function receiveObjectIdsEnable(){$("#receiveObjectIds_label").show();$("#receiveObjectIds_input").show();$("#receiveObjectIds_op_input").show()}function receiveObjectIdsDisable(){$("#receiveObjectIds_label").hide();$("#receiveObjectIds_input").hide();$("#receiveObjectIds_op_input").hide()}function sendObjectIdsEnable(){$("#sendObjectIds_label").show();$("#sendObjectIds_input").show();$("#sendObjectIds_op_input").show()}function sendObjectIdsDisable(){$("#sendObjectIds_label").hide();$("#sendObjectIds_input").hide();$("#sendObjectIds_op_input").hide()}function reduce(){var a=$email_datagrid.datagrid("getChecked");if(a.length>0){$.messager.confirm("确认提示！","您确定要恢复所有行?",function(c){if(c){var b=new Array();$.each(a,function(d,e){b[d]=e.id});$.ajax({url:ctxAdmin+"/mail/email/reduce",type:"post",data:{recycleBinIds:b},dataType:"json",traditional:true,success:function(d){if(d.code==1){$email_datagrid.datagrid("reload",{mailAccountId:currentMailAccountId});eu.showMsg(d.msg)}else{eu.showAlertMsg(d.msg,"error")}}})}})}else{eu.showMsg("请选择要操作的对象！")}}function edit(e,b,c,a){var d=currentMailAccountId;if("1"==currentMailAccountId){d=""}var f=ctxAdmin+"/mail/email/input?operateType=";if(e!=undefined){f+=e}if(b!=undefined){f+="&id="+b}f+="&mailAccountId="+d;if("QuickWriteMail"==e){if(c!=undefined){f+="&receiveObjectType="+c}if(a!=undefined){f+="&receiveObjectId="+a}if($email_view_dialog!=undefined){$email_view_dialog.dialog("destroy")}}$email_input_dialog=$("<div/>").dialog({title:"邮件",width:document.body.clientWidth,height:document.body.clientHeight,modal:true,maximizable:true,href:f,buttons:[{text:"发送",iconCls:"eu-icon-mail_forward",handler:function(){_operateType="Send";$email_form.submit()}},{text:"保存草稿",iconCls:"easyui-icon-save",handler:function(){_operateType="SaveDraft";$email_form.submit()}},{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){if($email_datagrid){$email_datagrid.datagrid("reload",{mailAccountId:currentMailAccountId})}$email_input_dialog.dialog("destroy")}}],onClose:function(){if($email_datagrid){$email_datagrid.datagrid("reload",{mailAccountId:currentMailAccountId})}$email_input_dialog.dialog("destroy")},onLoad:function(){formInit()}})}function revoke(b){$email_datagrid.datagrid("unselectAll");$email_datagrid.datagrid("selectRow",b);var a=$email_datagrid.datagrid("getSelected");$email_datagrid.datagrid("unselectRow",b);$.messager.confirm("确认提示！","您确定要撤销发送邮件["+a.title+"]?",function(c){if(c){$.ajax({url:ctxAdmin+"/mail/email/revoke/"+a.emailId,type:"post",data:{},dataType:"json",traditional:true,success:function(d){if(d.code==1){$email_datagrid.datagrid("reload",{mailAccountId:currentMailAccountId});eu.showMsg(d.msg);refreshMessage()}else{eu.showAlertMsg(d.msg,"error")}}})}})}function emailReadInfo(a){var c=ctxAdmin+"/mail/email/readInfo/"+a;var b=$("<div/>").dialog({title:"邮件阅读情况",width:500,height:400,modal:true,maximizable:true,href:c,buttons:[{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){b.dialog("destroy")}}],onClose:function(){b.dialog("destroy")}})}function view(b,e,f){var a={text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){$email_view_dialog.dialog("destroy");$email_datagrid.datagrid("reload",{mailAccountId:currentMailAccountId});refreshMessage()}};var h=new Array();var d={text:"回复",iconCls:"eu-icon-mail_reply_sender",handler:function(){$email_view_dialog.dialog("destroy");edit("Reply",e)}};var g={text:"转发",iconCls:"eu-icon-mail_forward",handler:function(){$email_view_dialog.dialog("destroy");edit("Repeat",e)}};if("Inbox"==b||"UnreadInbox"==b){if("1"==f){h.push(d)}}h.push(g);h.push(a);var c=ctxAdmin+"/mail/email/view/"+e;$email_view_dialog=$("<div/>").dialog({title:"查看邮件",width:document.body.clientWidth-90,height:document.body.clientHeight-10,modal:true,maximizable:true,content:'<iframe id="email_view_iframe" scrolling="no" frameborder="0"  src="'+c+'" ></iframe>',buttons:h,onClose:function(){$(this).dialog("destroy");$email_datagrid.datagrid("reload",{mailAccountId:currentMailAccountId});refreshMessage()}})}function sendEmail(a){$.post(ctxAdmin+"/mail/email/sendEmail/"+a,{},function(c){var b=$.parseJSON(c);if(b.code==1){$email_datagrid.datagrid("reload",{mailAccountId:currentMailAccountId});eu.showMsg(b.msg)}else{eu.showAlertMsg(b.msg,"error")}})}function formInit(){$email_form=$("#email_form").form({url:ctxAdmin+"/mail/email/_save",onSubmit:function(b){$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});if($form_to_MultiSelect&&$form_to_MultiSelect.value().length==0){$.messager.progress("close");eu.showTopCenterMsg("收件人不能为空，请设置收件人!");$form_to_MultiSelect.focus();return false}var a=$(this).form("validate");if(!a){$.messager.progress("close")}else{b.operateType=_operateType}return a},success:function(b){$.messager.progress("close");var a=$.parseJSON(b);if(a.code==1){$email_datagrid.datagrid("reload",{mailAccountId:currentMailAccountId});$email_input_dialog.dialog("destroy");eu.showMsg(a.msg)}else{if(a.code==2){}else{eu.showAlertMsg(a.msg,"error")}}}})}function clearEmail(){var a=$email_datagrid.datagrid("getChecked");if(a.length>0){var b="您确定要永久删除选中的邮件?";$.messager.confirm("确认提示！",b,function(d){if(d){var c=new Array();$.each(a,function(e,f){c[e]=f.id});$.ajax({url:ctxAdmin+"/mail/email/clearRecycleBin",type:"post",data:{recycleBinIds:c},dataType:"json",traditional:true,success:function(e){if(e.code==1){$email_datagrid.datagrid("load",{mailAccountId:currentMailAccountId});eu.showMsg(e.msg)}else{eu.showAlertMsg(e.msg,"error")}}})}})}else{eu.showMsg("请选择要操作的对象！")}}function del(a,e){var c=new Array();var d="您确定要删除选中的所有行?";if(e!=undefined){$email_datagrid.datagrid("unselectAll");$email_datagrid.datagrid("selectRow",e);var b=$email_datagrid.datagrid("getSelected");c.push(b);$email_datagrid.datagrid("unselectRow",e);d="您确定要删除["+b.title+"]？"}else{c=$email_datagrid.datagrid("getChecked")}if(c.length>0){$.messager.confirm("确认提示！",d,function(g){if(g){var f=new Array();$.each(c,function(h,j){f[h]=j.id});$.ajax({url:ctxAdmin+"/mail/email/_remove",type:"post",data:{ids:f,boxType:a},dataType:"json",traditional:true,success:function(h){if(h.code==1){$email_datagrid.datagrid("load",{mailAccountId:currentMailAccountId});eu.showMsg(h.msg);refreshMessage()}else{eu.showAlertMsg(h.msg,"error")}}})}})}else{eu.showMsg("请选择要操作的对象！")}}function markReaded(){var a=$email_datagrid.datagrid("getChecked");if(a.length>0){$.messager.confirm("确认提示！","您确定要标记所有行为已读？",function(c){if(c){var b=new Array();$.each(a,function(d,e){b[d]=e.id});$.ajax({url:ctxAdmin+"/mail/email/markReaded",type:"post",data:{inboxIds:b},dataType:"json",traditional:true,success:function(d){if(d.code==1){$email_datagrid.datagrid("reload",{mailAccountId:currentMailAccountId});eu.showMsg(d.msg);refreshMessage()}else{eu.showAlertMsg(d.msg,"error")}}})}})}else{eu.showMsg("请选择要操作的对象！")}}function search(){var a={};var c={mailAccountId:currentMailAccountId};var b=$.serializeObject($email_search_form);a=$.extend(a,c,b);$email_datagrid.datagrid("load",a)}function resetSearchForm(){$email_search_form.form("reset")}function selectSendUser(){$datagrid_query_MultiSelect=$datagrid_query_sender_MultiSelect;selectUser()}function selectPublishUser(){$datagrid_query_MultiSelect=$datagrid_query_receiver_MultiSelect;selectUser()}function selectUser(){var c="";var b=$datagrid_query_MultiSelect.dataItems();if(b&&b.length>0){var a=b.length;$.each(b,function(e,d){if(e==a-1){c+=d.id}else{c+=d.id+","}})}_dialog=$("<div/>").dialog({title:"选择用户",top:10,href:ctxAdmin+"/sys/user/organUserTreePage?checkedUserIds="+c,width:"500",height:"360",maximizable:true,iconCls:"eu-icon-user",modal:true,buttons:[{text:"确定",iconCls:"easyui-icon-save",handler:function(){setSelectUser();_dialog.dialog("destroy")}},{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){_dialog.dialog("destroy")}}],onClose:function(){_dialog.dialog("destroy")}})}function setSelectUser(){var b=new Array();var a=$("#organUserTree").tree("getChecked");$.each(a,function(c,d){if("u"==d.attributes.nType){b.push(d.id)}});$datagrid_query_MultiSelect.value(b)}function toggleMailAccount(b,a){currentMailAccountId=b;if(a){$("#btn_mailAccount").menubutton({text:a})}refreshMessage();resetSearchForm();$email_datagrid.datagrid("reload",{mailAccountId:currentMailAccountId})}function receiveMail(){var a=currentMailAccountId;if("1"==currentMailAccountId){a=""}$.ajax({type:"post",dataType:"json",contentType:"application/json",url:ctxAdmin+"/mail/email/receiveMail?mailAccountId="+a,success:function(b){if(b.code==1){refreshMessage();eu.showMsg(b.msg)}else{eu.showAlertMsg(b.msg)}}})};