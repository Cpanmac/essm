var jsessionid=jsessionid;var toIds=toIds;var ccIds=ccIds;var modelPriority=modelPriority;var PREFIX_USER=PREFIX_USER;var fileSizeLimit=fileSizeLimit;var $form_to_MultiSelect=undefined;var $form_cc_MultiSelect=undefined;var $form_CurrentUser_MultiSelect=undefined;var current_input_values=new Array();var $form_selectUser_dialog=undefined;var _currentMailAccountId=_mailAccountId;function isString(a){return typeof(a)==="string"||a instanceof String}var inputTOValue="";var inputCCValue="";var toValues=toIds;var ccValues=ccIds;if(toValues==undefined||isString(toValues)||toValues.length==0){toValues=new Array()}if(ccValues==undefined||isString(ccValues)||ccValues.length==0){ccValues=new Array()}$(function(){loadMailPriority();initFormUser();uploadify();editor()});function editor(){$("#editor").kendoEditor({encoded:false,resizable:{content:true,toolbar:true}})}function setCurrentUserMultiSelect(a){if(a=="cc"){$form_CurrentUser_MultiSelect=$form_cc_MultiSelect;current_input_values=ccValues}else{$form_CurrentUser_MultiSelect=$form_to_MultiSelect;current_input_values=toValues}}function selectFormUser(d){setCurrentUserMultiSelect(d);var b=$form_CurrentUser_MultiSelect.dataItems();var e="";if(b!=null){var a=b.length;var c=0;$.each(b,function(h,g){var f=g.id;if(f.substring(0,3)==PREFIX_USER){f=f.substring(3,f.length);c++;if(c==0){e+=f}else{e+=","+f}}})}$form_selectUser_dialog=$("<div/>").dialog({title:"选择",top:10,href:ctxAdmin+"/sys/user/select?dataScope=1&cascade=true&userIds=&excludeUserIds="+e.toString(),width:"760",height:"450",maximizable:true,iconCls:"easyui-icon-edit",modal:true,buttons:[{text:"确定",iconCls:"easyui-icon-save",handler:function(){_setSelectUser()}},{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){$form_selectUser_dialog.dialog("destroy")}}],onClose:function(){$form_selectUser_dialog.dialog("destroy")},onLoad:function(){}})}function _setSelectUser(){var a=$form_CurrentUser_MultiSelect.value().slice();$("#selectUser option").each(function(){var b=$(this).val();var c=PREFIX_USER+$.trim(b);$form_CurrentUser_MultiSelect.dataSource.add({id:c,name:c,group:c});current_input_values.push(c);a.push(c)});$form_CurrentUser_MultiSelect.dataSource.filter({});$form_CurrentUser_MultiSelect.value(a);$form_selectUser_dialog.dialog("destroy")}function convertValues(b,c){c=$.isArray(c)?c:[c];var e="";var a="";if(b!=undefined){e=b.input.val();var f=b.value();if(f!=undefined&&f.length>0){c=$.unique($.merge(c,f))}}if(c!=undefined){a=c.join(",")}var d={};d.mailAccountId=_currentMailAccountId;d.query=e;d.includeIds=a;return d}function initFormUser(){$form_to_MultiSelect=$("#_toIds").kendoMultiSelect({dataTextField:"name",dataValueField:"id",groupTemplate:"#: data #",itemTemplate:kendo.template($("#itemTemplate").html()),tagTemplate:kendo.template($("#itemTemplate").html()),autoSync:true,dataSource:{transport:{read:{url:ctxAdmin+"/mail/mailContact/multiSelectPrefix",type:"post",dataType:"json"},parameterMap:function(b,a){if(a=="read"){return convertValues($form_to_MultiSelect,toValues)}}},serverFiltering:true,group:{field:"group"}},value:toIds,dataBound:function(a){inputTOValue=$form_to_MultiSelect.input.val();dataBound($form_to_MultiSelect,toValues)}}).data("kendoMultiSelect");$form_to_MultiSelect.input.bind("blur",function(){autoAddEmail($form_to_MultiSelect,inputTOValue,toValues)});$form_cc_MultiSelect=$("#ccIds").kendoMultiSelect({dataTextField:"name",dataValueField:"id",groupTemplate:"#: data #",itemTemplate:kendo.template($("#itemTemplate").html()),tagTemplate:kendo.template($("#itemTemplate").html()),autoSync:true,dataSource:{transport:{read:{url:ctxAdmin+"/mail/mailContact/multiSelectPrefix",type:"post",dataType:"json"},parameterMap:function(b,a){if(a=="read"){return convertValues($form_cc_MultiSelect,ccValues)}}},serverFiltering:true,group:{field:"group"}},value:ccIds,dataBound:function(a){inputCCValue=$form_cc_MultiSelect.input.val();dataBound($form_cc_MultiSelect,ccValues)}}).data("kendoMultiSelect");$form_cc_MultiSelect.input.bind("blur",function(){autoAddEmail($form_cc_MultiSelect,inputCCValue,ccValues)})}function dataBound(a,f){if(""==_currentMailAccountId){return}if(!a){return}var d=a.input;var c=d.val();var e=/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;if(c.charAt(c.length-1)==";"||c.charAt(c.length-1)=="；"){d.val("");var b=c.substring(0,c.length-1);$.ajax({type:"post",dataType:"json",contentType:"application/json",url:ctxAdmin+"/mail/mailContact/autoAdd?email="+b,async:true,success:function(h){if(h.code==1){var i=h.obj;a.dataSource.add(i);var g=a.value().slice();g.push(i.id);f.push(i.id);a.dataSource.filter({});a.value(g)}else{d.val(b);eu.showMsg(h.msg)}}})}}function autoAddEmail(b,a,f){if(""==_currentMailAccountId){return}if(!b){return}var d=b.input;var c=a;var e=/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;if(c!=undefined&&e.test(c)){$.ajax({url:ctxAdmin+"/mail/mailContact/autoAdd",data:{email:c},type:"post",dataType:"json",success:function(h){if(h.code==1){var i=h.obj;b.dataSource.add(i);b.dataSource.sync();var g=b.value().slice();g.push(i.id);f.push(i.id);b.dataSource.filter({});b.value(g)}else{$.afui.toast({message:h.msg,position:"tc",autoClose:true,type:"warning"});b.focus()}}})}}function loadMailPriority(){$("#priority").combobox({url:ctxAdmin+"/mail/email/mailPriorityCombobox",editable:false,value:modelPriority})}function loadMailAccount(){$("#mailAccountId").combobox({url:ctxAdmin+"/mail/mailAccount/combobox?selectType=站内邮箱",editable:false,value:_currentMailAccountId})}var $uploadify;var fileIdArray=new Array();var fileIds=$("#fileIds").val();if(fileIds!=""){fileIdArray=fileIds.split(",")}function uploadify(){$uploadify=$("#uploadify").uploadify({swf:ctxStatic+"/js/uploadify/scripts/uploadify.swf",buttonText:"浏  览",uploader:ctxAdmin+"/mail/email/upload;jsessionid="+jsessionid,queueSizeLimit:10,fileObjName:"uploadFile",removeCompleted:false,multi:true,fileSizeLimit:fileSizeLimit,fileTypeDesc:"所有文件",fileTypeExts:"*.*",onUploadSuccess:function(file,data,response){data=eval("("+data+")");if(data.code!=undefined&&data.code=="1"){$("#"+file.id).find(".data").html(" - 上传成功!");if(data.code!=undefined&&data.code==1){fileIdArray.push(data.obj)}var _fileIds=fileIdArray.join(",");$("#fileIds").val(_fileIds);var uploadify=this;var cancel=$('#uploadify-queue .uploadify-queue-item[id="'+file.id+'"]').find(".cancel a");if(cancel){cancel.attr("rel",data.obj);cancel.click(function(){delUpload(data.obj,file.id,uploadify)})}}else{$("#"+file.id).find(".data").html(" - <font color=#D94600>"+data.msg+"</font>")}}})}function loadOrOpen(a){$("#annexFrame").attr("src",ctxAdmin+"/disk/fileDownload/"+a)}function delUpload(b,d,c){fileIdArray.splice($.inArray(b,fileIdArray),1);var a=fileIdArray.join(",");$("#fileIds").val(a);$("#"+b).remove();if(d){$("#"+d).empty();delete c.queueData.files[d];$("#"+d).remove()}};